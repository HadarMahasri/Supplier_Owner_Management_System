# docker-compose.ultra-fast.yml - Docker Compose מאופטמ למהירות מקסימלית
version: '3.8'

services:
  ollama-ultra:
    image: ollama/ollama:latest
    container_name: ollama_ultra_fast
    ports:
      - "11434:11434"
    volumes:
      - ollama_ultra_data:/root/.ollama
    environment:
      # אופטימיזציות מהירות מקסימלית
      - OLLAMA_NUM_PARALLEL=2
      - OLLAMA_MAX_LOADED_MODELS=1
      - OLLAMA_FLASH_ATTENTION=1
      - OLLAMA_LOW_VRAM=true
      - OLLAMA_KEEP_ALIVE=5m
      - OLLAMA_MAX_QUEUE=2
      - OLLAMA_CONCURRENCY=1
      # הגדרות זיכרון
      - OLLAMA_MAX_VRAM=1GB
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G  # הגבלת זיכרון
        reservations:
          memory: 1G
    # GPU support (הסר comment אם יש GPU)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # שירות אתחול מודלים
  ollama-setup:
    image: curlimages/curl:latest
    container_name: ollama_model_setup
    depends_on:
      ollama-ultra:
        condition: service_healthy
    volumes:
      - ./setup_models.sh:/setup_models.sh:ro
    command: |
      sh -c "
        echo '🚀 מתחיל התקנת מודלים...'
        
        # המתן שOllama יהיה מוכן
        for i in \$$(seq 1 30); do
          if curl -s http://ollama-ultra:11434/api/version >/dev/null; then
            echo '✅ Ollama מוכן!'
            break
          fi
          echo 'ממתין לOllama... (\$$i/30)'
          sleep 2
        done
        
        # התקן מודלים קלים
        echo '⬇️ מתקין מודל qwen2.5:0.5b...'
        curl -X POST http://ollama-ultra:11434/api/pull \
          -H 'Content-Type: application/json' \
          -d '{\"name\":\"qwen2.5:0.5b\"}'
          
        echo '⬇️ מתקין מודל tinyllama חלופי...'
        curl -X POST http://ollama-ultra:11434/api/pull \
          -H 'Content-Type: application/json' \
          -d '{\"name\":\"tinyllama\"}'
          
        echo '✅ התקנת מודלים הושלמה!'
        
        # בדיקה
        curl -X POST http://ollama-ultra:11434/api/generate \
          -H 'Content-Type: application/json' \
          -d '{\"model\":\"qwen2.5:0.5b\",\"prompt\":\"שלום\",\"stream\":false}' | head -c 200
          
        echo '🎉 הכל מוכן!'
      "
    restart: "no"

volumes:
  ollama_ultra_data:
    driver: local

networks:
  default:
    name: ollama_ultra_network